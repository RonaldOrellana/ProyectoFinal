{% extends 'base.html' %}
{% block content %}
<style>
body {
  background: #f4f7fb;
  font-family: 'Poppins', sans-serif;
}
.header-section {
  background: linear-gradient(135deg, #1f62cc, #5a35d4);
  color: white;
  border-radius: 25px;
  padding: 60px 20px;
  text-align: center;
  margin-bottom: 50px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.2);
}
.header-section h1 {
  font-size: 2.8rem;
  font-weight: 700;
}
.header-section p {
  font-size: 1.3rem;
  opacity: 0.9;
  margin-top: 10px;
}
.card-cita {
  background: #ffffff;
  border: none;
  border-radius: 25px;
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
  overflow: hidden;
  transition: all 0.4s ease;
}
.card-cita:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
}
.card-body {
  padding: 1.8rem;
}
.cita-title {
  font-size: 1.3rem;
  font-weight: 600;
  color: #2e7d32;
  margin-bottom: 10px;
}
.cita-info {
  color: #388e3c;
  font-weight: 500;
  font-size: 1rem;
  margin-bottom: 5px;
}
.btn-modern {
  border-radius: 30px;
  font-weight: 600;
  transition: all 0.3s ease;
}
.btn-modern:hover {
  transform: scale(1.05);
}
.card-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 30px;
}
.fade-in {
  animation: fadeIn 0.7s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
.badge-confirmada { background: #43a047; color: white; }
.badge-pendiente  { background: #fbc02d; color: white; }
.badge-cancelada { background: #e53935; color: white; }
</style>

<section class="header-section fade-in">
  <h1>ðŸ“… Citas Registradas</h1>
  <p>Gestiona tus citas de forma rÃ¡pida y ordenada.</p>
</section>

<div class="container mb-5 fade-in">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-secondary mb-0">Todas las Citas</h4>
    <a href="{% url 'registrar_cita' %}" class="btn btn-success btn-modern shadow-sm px-4">
      <i class="bi bi-plus-circle me-2"></i> Nueva Cita
    </a>
  </div>

  {% if citas %}
    <div class="card-container">
      {% for cita in citas %}
        <div class="card-cita">
          <div class="card-body">
            <h5 class="cita-title">{{ cita.paciente.nombre }} â€“ {{ cita.medico.nombre }}</h5>
            <p class="cita-info"><i class="bi bi-calendar"></i> Fecha: {{ cita.fecha }}</p>
            <p class="cita-info"><i class="bi bi-clock"></i> Hora: {{ cita.hora }}</p>
            <p class="cita-info"><i class="bi bi-clipboard"></i> Servicio: {{ cita.servicio.nombre }}</p>

            {% if cita.estado == 'Confirmada' %}
              <span class="badge badge-confirmada">Confirmada</span>
            {% elif cita.estado == 'Pendiente' %}
              <span class="badge badge-pendiente">Pendiente</span>
            {% elif cita.estado == 'Cancelada' %}
              <span class="badge badge-cancelada">Cancelada</span>
            {% endif %}

            <div class="d-flex justify-content-between mt-3">
              <a href="{% url 'editar_cita' cita.id %}" class="btn btn-outline-primary btn-modern btn-sm px-4">
                <i class="bi bi-pencil"></i> Editar
              </a>
              <a href="{% url 'eliminar_cita' cita.id %}" class="btn btn-outline-danger btn-modern btn-sm px-4">
                <i class="bi bi-trash"></i> Eliminar
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center shadow-sm">
      <i class="bi bi-info-circle"></i> No hay citas registradas aÃºn.
    </div>
  {% endif %}
</div>

  {# EstadÃ­sticas: bloque PIN-protegido que aparece debajo de la lista de citas #}
  <div class="container mb-5">
    {% if stats_unlocked %}
    <!-- ðŸ“Š EstadÃ­sticas de citas mÃ©dicas (desbloqueadas) -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card shadow-sm border-0 rounded-4 mb-3">
          <div class="card-body py-4">
            <h4 class="fw-bold text-primary mb-3"><i class="bi bi-bar-chart-line"></i> EstadÃ­sticas de Citas MÃ©dicas
              <a href="{% url 'lock_stats' %}" class="btn btn-sm btn-outline-secondary ms-3">Ocultar</a>
            </h4>
            <div class="row text-center">
              <div class="col-md-3 mb-2">
                <div class="fs-5 text-secondary">Total de citas</div>
                <div class="display-6 fw-bold text-dark">{{ total_citas }}</div>
              </div>
              <div class="col-md-3 mb-2">
                <div class="fs-5 text-secondary">PrÃ³ximas</div>
                <div class="display-6 fw-bold text-success">{{ total_citas_proximas }}</div>
              </div>
              <div class="col-md-3 mb-2">
                <div class="fs-5 text-secondary">Hoy</div>
                <div class="display-6 fw-bold text-info">{{ total_citas_hoy }}</div>
              </div>
              <div class="col-md-3 mb-2">
                <div class="fs-5 text-secondary">Realizadas</div>
                <div class="display-6 fw-bold text-muted">{{ total_citas_realizadas }}</div>
              </div>
            </div>
            <hr>
            <div class="fs-5 text-secondary">Total en costos</div>
            <div class="display-6 fw-bold text-success">${{ total_costos }}</div>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Formulario para desbloquear estadÃ­sticas con PIN -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm border-0 rounded-4 mb-3">
          <div class="card-body py-4">
            <h5 class="fw-semibold mb-3">ðŸ”’ EstadÃ­sticas privadas</h5>
            <p class="text-muted">Introduce el PIN para ver el resumen completo de citas.</p>
            <form method="post" action="{% url 'unlock_stats' %}">
              {% csrf_token %}
              <div class="input-group mb-3">
                <input type="password" name="pin" class="form-control" placeholder="PIN" aria-label="PIN">
                <button class="btn btn-primary" type="submit">Desbloquear</button>
              </div>
              <small class="text-muted">Pista: pregunta al administrador.</small>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

{% endblock %}
